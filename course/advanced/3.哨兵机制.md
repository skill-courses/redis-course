# Redis Sentinel(哨兵机制)

![redis-sentinel](https://tva1.sinaimg.cn/large/008i3skNly1gxxdpd96djj30sg0evgmj.jpg)

在 Web 服务器中，高可用是指服务器可以正常访问的时间，衡量的标准是在多长时间内可以提供正常服务，通常通过几个9来衡量，例如（99.9%、99.99%、99.999% 等等）。在 Redis 层面，高可用的含义要宽泛一些，除了保证提供正常服务（如主从分离、快速容灾技术等），还需要考虑数据容量扩展、数据安全，故障的转移等等

前面我们学习了主从复制的架构，这是否意味着你就可以实现Redis集群的高可用？答案是否定的，要真正实现高可用架构，就必须实现自动化故障转移机制。

什么是自动化的故障转移呢？当Redis主从复制中，当检测到Master节点宕机之后，自动从Slave节点中选举出一个节点称为新的Master的过程，我们称之为**自动化的故障转移机制**。

而主动复制架构是无法完成自动化的故障转移的，Master节点宕机之后，几乎也就凉凉了。。。。想要实现自动化的故障转移，Redis引入的Sentinel(哨兵)机制来完成这一壮举。

## Redis Sentinel

Redis Sentinel为Redis提供了高可用解决方案。实际上这意味着使用Sentinel可以部署一套Redis，在没有人为干预的情况下去应付各种各样的失败事件.

Redis Sentinel同时提供了一些其他的功能，例如：监控、通知、并为client提供配置。

### 下面是Sentinel的功能列表：

* 监控(Monitoring): Sentinel不断的去检查你的主从实例是否按照预期在工作。
* 通知(Notification): Sentinel可以通过一个api来通知系统管理员或者另外的应用程序，被监控的Redis实例有一些问题。
* 自动故障转移(Automatic failover): 如果一个主节点没有按照预期工作，Sentinel会开始故障转移过程，把一个从节点提升为主节点，并重新配置其他的从节点使用新的主节点，使用Redis服务的应用程序在连接的时候也被通知新的地址。
* 配置提供者(Configuration provider): Sentinel给客户端的服务发现提供来源：对于一个给定的服务，客户端连接到Sentinels来寻找当前主节点的地址。当故障转移发生的时候，Sentinels将报告新的地址。

### Sentinel的分布式特性
Redis Sentinel是一个分布式系统，Sentinel运行在有许多Sentinel进程互相合作的环境下，它本身就是这样被设计的。有许多Sentinel进程互相合作的优点如下：

* 当多个Sentinel同意一个master不再可用的时候，就执行故障检测。这明显降低了错误概率。
* 即使并非全部的Sentinel都在工作，Sentinel也可以正常工作，这种特性，让系统非常的健康。

## Redis Sentinel架构

![redis-sentinel-structure](https://tva1.sinaimg.cn/large/008i3skNly1gxxem2uproj30tx0mbacs.jpg)

Redis层是典型的主从复制架构，有一主多从组成。哨兵层会有多个哨兵组成，每个哨兵都会对Redis主从架构的所有节点进行监控，如果发现问题，将会选举出新的Master，进而实现故障转移。

同时，客户端只需要连接到哨兵层即可，不需要知晓Redis层是如何实现的，哨兵层会自动实现故障转移，对于客户端几乎是无感知的。

## Redis Sentinel工作原理

### 三个定时任务

### 主观下线和客观下线

### 领导者选举

### 故障转移实现过程


